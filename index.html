<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stillnight â€“ Win 3.1 Stack (Enhanced)</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="desktop">
    <div class="win-window">
        <div class="title-bar">
            <div class="title-group">
                <div class="title-icon"></div>
                <div class="title">Stillnight â€“ Windows 3.1 Stack</div>
            </div>
            <div class="sys-buttons">
                <button class="win-btn" id="btn-theme" title="Theme">ðŸŽ¨</button>
                <button class="win-btn" title="Minimize">_</button>
                <button class="win-btn" title="Maximize">â–¢</button>
                <button class="win-btn" title="Close">X</button>
            </div>
        </div>

        <div class="window-content">
            <!-- Left side: stack + run controls -->
            <div class="stack-nav panel">
                <h1>Stillnight Stack</h1>

                <div class="group-box">
                    <legend>Run</legend>
                    <div class="stack-nav-buttons">
                        <button class="win-btn" id="btn-new-run">New Run</button>
                        <button class="win-btn" id="btn-reveal-all">Reveal</button>
                    </div>
                    <div style="margin-top:4px;">
                        <div>Card: <span id="card-index-label">1 / 1</span></div>
                        <div>Floor depth: <span id="card-depth-label">1</span></div>
                    </div>
                </div>

                <div class="group-box">
                    <legend>Cards (Floors)</legend>
                    <div class="card-list" id="card-list"></div>
                </div>

                <div class="group-box">
                    <legend>Short Help</legend>
                    <div class="info-box">
                        â€¢ Each floor is a card.<br>
                        â€¢ â˜º is your party (highlighted).<br>
                        â€¢ Click adjacent tiles to move.<br>
                        â€¢ E triggers a battle.<br>
                        â€¢ R heals, S descends.<br>
                        â€¢ Â¥ opens a shop.<br>
                        â€¢ Front row hits harder,<br>
                        &nbsp;&nbsp;back row is safer.<br>
                        â€¢ Floors are reachable only<br>
                        &nbsp;&nbsp;if you've reached their<br>
                        &nbsp;&nbsp;stairs at least once.<br>
                        â€¢ Shrines may offer<br>
                        &nbsp;&nbsp;mysterious events.<br>
                        â€¢ Boss awaits at the deepest floor.
                    </div>
                </div>
            </div>

            <!-- Right side: exploration card + party/log -->
            <div class="right-side">
                <div class="card-area">
                    <!-- Main â€œcardâ€ -->
                    <div class="card-main panel">
                        <div class="card-header">
                            <div>
                                <span class="card-header-title" id="card-title">Floor 1</span>
                            </div>
                            <div>
                                <span class="label">Mode:</span>
                                <span id="mode-label">Exploration</span>
                            </div>
                        </div>

                        <div class="exploration-frame panel">
                            <div class="exploration-grid" id="exploration-grid"></div>
                            <div class="legend">
                                <span>â˜º = Party</span>
                                <span>â–ˆ = Wall</span>
                                <span>E = Enemy</span>
                                <span>R = Recovery</span>
                                <span>S = Stairs</span>
                                <span>â™± = Shrine</span>
                                <span>Â¥ = Shop</span>
                                <span>? = Unseen</span>
                    <span>U = Recruit</span>
                            </div>
                        </div>
                    </div>

                    <!-- Party + log (fixed width column) -->
                    <div class="card-side-panels">
                        <div class="party-panel panel">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span>Party Status (click to inspect)</span>
                                <button class="win-btn" style="font-size:10px; padding:0 6px;" id="btn-formation">
                                    Formation...
                                </button>
                                <button class="win-btn" style="font-size:10px; padding:0 6px;" id="btn-inventory">
                                    Inventory...
                                </button>
                            </div>
                            <div class="party-grid" id="party-grid"></div>
                        </div>

                        <div class="log-panel panel">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span>Event Log</span>
                                <button class="win-btn" style="font-size:10px; padding:0 6px;" id="btn-clear-log">
                                    Clear
                                </button>
                            </div>
                            <div class="log-content" id="log-content"></div>
                        </div>
                    </div>
                </div>

                <div class="status-bar">
                    <div>
                        <span id="status-message">Ready.</span>
                    </div>
                    <div>
                        <span>Gold: <span id="status-gold">0</span></span>
                        <span>| Floor: <span id="status-floor">1</span></span>
                        <span>| Cards: <span id="status-cards">1</span></span>
                        <span>| Run: <span id="status-run">Active</span></span>
                        <span>| Items: <span id="status-items">0</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Battle modal -->
        <div class="modal-overlay" id="battle-overlay">
            <div class="dialog dialog-battle">
                <div class="dialog-titlebar">
                    <span>Battle â€“ Stillnight</span>
                    <button class="win-btn" id="btn-battle-close">X</button>
                </div>
                <div class="dialog-content">
                    <div class="dialog-ascii" id="battle-ascii"></div>
                    <div class="dialog-log" id="battle-log"></div>
                    <div class="dialog-buttons">
                        <button class="win-btn" id="btn-battle-victory">Victory!</button>
                        <button class="win-btn" id="btn-battle-round">Resolve Round</button>
                        <button class="win-btn" id="btn-battle-flee">Flee</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inspect creature modal -->
        <div class="modal-overlay" id="inspect-overlay">
            <div class="dialog dialog-inspect">
                <div class="dialog-titlebar">
                    <span>Creature â€“ Stillnight</span>
                    <button class="win-btn" id="btn-inspect-close">X</button>
                </div>
                <div class="dialog-content">
                    <div class="inspect-body">
                        <div class="inspect-layout">
                            <div class="inspect-sprite" id="inspect-sprite"></div>
                            <div class="inspect-fields">
                                <div class="inspect-row">
                                    <span class="inspect-label">Name</span>
                                    <span class="inspect-value" id="inspect-name"></span>
                                </div>
                                <div class="inspect-row">
                                    <span class="inspect-label">Level</span>
                                    <span class="inspect-value" id="inspect-level"></span>
                                </div>
                                <div class="inspect-row">
                                    <span class="inspect-label">Row</span>
                                    <span class="inspect-value" id="inspect-rowpos"></span>
                                </div>
                                <div class="inspect-row">
                                    <span class="inspect-label">HP</span>
                                    <span class="inspect-value" id="inspect-hp"></span>
                                </div>
                                <div class="inspect-row">
                                    <span class="inspect-label">XP</span>
                                    <span class="inspect-value" id="inspect-xp"></span>
                                </div>
                                <div class="inspect-row">
                                    <span class="inspect-label">Element</span>
                                    <span class="inspect-value" id="inspect-element"></span>
                                </div>
                                <div class="inspect-row">
                                    <span class="inspect-label">Equipment</span>
                                    <button class="win-btn inspect-value" id="inspect-equip"></button>
                                </div>
                                <div id="inspect-equipment-list-container" style="display: none;">
                                    <div class="group-box">
                                        <legend>Change Equipment</legend>
                                        <div id="inspect-equipment-filter" class="stack-nav-buttons" style="margin-bottom: 4px;"></div>
                                        <div id="inspect-equipment-list"></div>
                                    </div>
                                </div>
                                <div class="inspect-row">
                                    <span class="inspect-label">Passive</span>
                                    <span class="inspect-value" id="inspect-passive"></span>
                                </div>
                                <div class="inspect-row">
                                    <span class="inspect-label">Skills</span>
                                    <span class="inspect-value" id="inspect-skills"></span>
                                </div>
                                <div class="inspect-row">
                                    <span class="inspect-label">Flavor</span>
                                    <span class="inspect-value" id="inspect-flavor"></span>
                                </div>
                            </div>
                        </div>
                        <div class="inspect-notes" id="inspect-notes"></div>
                    </div>
                    <div class="dialog-buttons">
                        <button class="win-btn" id="btn-inspect-ok">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shop modal -->
        <div class="modal-overlay" id="shop-overlay">
            <div class="dialog dialog-shop">
                <div class="dialog-titlebar">
                    <span>Shop â€“ Stillnight</span>
                    <button class="win-btn" id="btn-shop-close">X</button>
                </div>
                <div class="dialog-content">
                    <div class="shop-body">
                        <div class="shop-row">
                            Current gold: <span class="shop-gold" id="shop-gold-label">0</span>G
                        </div>
                        <!-- dynamic items will be inserted here -->
                        <div id="shop-item-list"></div>
                        <div class="shop-row" id="shop-message" style="margin-top:6px; font-size:10px;">
                            The vendor waits silently.
                        </div>
                    </div>
                    <div class="dialog-buttons">
                        <button class="win-btn" id="btn-shop-leave">Leave</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formation modal -->
        <div class="modal-overlay" id="formation-overlay">
            <div class="dialog dialog-formation">
                <div class="dialog-titlebar">
                    <span>Formation â€“ Stillnight</span>
                    <button class="win-btn" id="btn-formation-close">X</button>
                </div>
                <div class="dialog-content">
                    <div class="formation-body">
                        <div class="formation-label">
                            Drag and drop to rearrange. Active party is the first 4 members.
                        </div>
                        <div class="formation-grid" id="formation-grid"></div>
                        <div class="formation-label" style="margin-top: 10px;">Reserve</div>
                        <div class="formation-reserve-grid" id="formation-reserve-grid"></div>
                    </div>
                    <div class="dialog-buttons">
                        <button class="win-btn" id="btn-formation-ok">OK</button>
                        <button class="win-btn" id="btn-formation-cancel">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory modal -->
        <div class="modal-overlay" id="inventory-overlay">
            <div class="dialog dialog-shop"> <!-- reuse shop styling -->
                <div class="dialog-titlebar">
                    <span>Inventory â€“ Stillnight</span>
                    <button class="win-btn" id="btn-inventory-close">X</button>
                </div>
                <div class="dialog-content">
                    <div class="shop-body">
                        <div class="shop-row" id="inventory-empty-message">Your bag is empty.</div>
                        <div id="inventory-list"></div>
                    </div>
                    <div class="dialog-buttons">
                        <button class="win-btn" id="btn-inventory-close2">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recruit modal -->
        <div class="modal-overlay" id="recruit-overlay">
            <div class="dialog dialog-inspect">
                <div class="dialog-titlebar">
                    <span>Recruit â€“ Stillnight</span>
                    <button class="win-btn" id="btn-recruit-close">X</button>
                </div>
                <div class="dialog-content">
                    <div class="inspect-body" id="recruit-body">
                        <!-- recruit info will be injected here (similar to inspect layout) -->
                    </div>
                    <div class="dialog-buttons" id="recruit-buttons">
                        <!-- buttons will be injected dynamically depending on state -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Generic Confirmation Dialog -->
        <div class="modal-overlay" id="confirm-overlay">
            <div class="dialog" style="width: 320px;">
                <div class="dialog-titlebar">
                    <span id="confirm-title">Confirmation</span>
                </div>
                <div class="dialog-content">
                    <div id="confirm-message" style="margin-bottom: 8px;"></div>
                    <div class="dialog-buttons">
                        <button class="win-btn" id="btn-confirm-ok">OK</button>
                        <button class="win-btn" id="btn-confirm-cancel">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Event modal -->
        <div class="modal-overlay" id="event-overlay">
            <div class="dialog dialog-event">
                <div class="dialog-titlebar">
                    <span id="event-title">Shrine Event</span>
                    <button class="win-btn" id="btn-event-close">X</button>
                </div>
                <div class="dialog-content">
                    <div class="event-body">
                        <div class="event-description" id="event-description"></div>
                        <div class="event-choices" id="event-choices"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script type="module" src="main.js"></script>
</body>
</html>
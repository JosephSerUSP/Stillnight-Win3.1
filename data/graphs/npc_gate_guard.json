{
  "id": "npc_gate_guard",
  "name": "Gate Guard",
  "layout": "visual_novel",
  "initialNode": "default_router",
  "nodes": {
    "default_router": {
      "type": "ROUTER",
      "branches": [
        { "condition": "questStatus:geraldo_badge:completed", "target": "quest_badge_done" },
        { "condition": "questStatus:geraldo_badge:active", "target": "quest_badge_active_text" },
        { "condition": "questStatus:geraldo_security:completed", "target": "quest_security_done" },
        { "condition": "questStatus:geraldo_security:active", "target": "quest_security_active_text" },
        { "condition": "questStatus:silent_shipment:completed", "target": "quest_complete_text" },
        { "condition": "questStatus:silent_shipment:active", "target": "quest_active_router" },
        { "condition": "hasItem:guild_pass", "target": "allow_pass_text" }
      ],
      "next": "deny_pass_text"
    },

    "quest_active_router": {
      "type": "ROUTER",
      "condition": "flag:shipment_investigated",
      "trueNode": "quest_turn_in_text",
      "falseNode": "quest_reminder_text"
    },

    "deny_pass_text": {
      "type": "TEXT",
      "content": "No Guild Pass. Speak to the Guildmaster in town. And don’t try to slip past. I’ve buried faster people than you.",
      "next": "deny_pass_choices"
    },
    "deny_pass_choices": {
      "type": "CHOICE",
      "options": [
        { "label": "Anything strange happening?", "target": "quest_offer_text", "condition": "questStatus:silent_shipment:inactive" },
        { "label": "Leave", "action": "close" }
      ]
    },

    "quest_offer_text": {
      "type": "TEXT",
      "content": "Strange? Always. But the supply shipment is late. Very late. It usually comes through the old tunnel, but it's silent.",
      "next": "quest_offer_choice"
    },
    "quest_offer_choice": {
      "type": "CHOICE",
      "options": [
        { "label": "I'll investigate.", "target": "action_offer_quest" },
        { "label": "Not my problem.", "action": "close" }
      ]
    },
    "action_offer_quest": {
      "type": "ACTION",
      "action": "OFFER_QUEST",
      "questId": "silent_shipment",
      "next": "close_choice"
    },

    "quest_reminder_text": {
      "type": "TEXT",
      "content": "Any news on the shipment? Ask Alicia, she usually hears the carts coming.",
      "next": "close_choice"
    },

    "quest_turn_in_text": {
      "type": "TEXT",
      "content": "So Alicia heard them stop near the chasm? Damn. That means goblins or worse. Thanks for the intel. I'll double the watch.",
      "next": "quest_complete_action"
    },
    "quest_complete_action": {
      "type": "ACTION",
      "action": "COMPLETE_QUEST",
      "questId": "silent_shipment",
      "next": "quest_complete_text"
    },
    "quest_complete_text": {
      "type": "TEXT",
      "content": "You did good work. Watch your back out there.",
      "next": "allow_pass_choices"
    },

    "allow_pass_text": {
      "type": "TEXT",
      "content": "Guild Pass verified. Keep your MP above the red line. Don’t be a hero in there— heroes become stains.",
      "next": "allow_pass_choices"
    },
    "allow_pass_choices": {
      "type": "CHOICE",
      "options": [
        { "label": "Enter Dungeon", "target": "action_teleport" },
        { "label": "Ask about stains.", "target": "allow_pass_stains_text" },
        { "label": "Anything strange?", "target": "quest_offer_text", "condition": "questStatus:silent_shipment:inactive" },
        { "label": "Security work?", "target": "quest_security_offer_check", "condition": "questStatus:silent_shipment:completed" },
        { "label": "Leave", "action": "close" }
      ]
    },
    "action_teleport": {
      "type": "ACTION",
      "action": "TELEPORT",
      "target": "dungeon_floor_1"
    },
    "allow_pass_stains_text": {
      "type": "TEXT",
      "content": "People come back talking about ‘treasure’. Then they stop sleeping. Then they stop talking. Then we stop calling them by name. Go.",
      "next": "allow_pass_stains_choices"
    },
    "allow_pass_stains_choices": {
      "type": "CHOICE",
      "options": [
        { "label": "Enter Dungeon", "target": "action_teleport" },
        { "label": "Leave", "action": "close" }
      ]
    },
    "close_choice": {
        "type": "CHOICE",
        "options": [
            { "label": "Leave", "action": "close" }
        ]
    },
    "quest_security_offer_check": {
      "type": "ROUTER",
      "condition": "questStatus:geraldo_security:inactive",
      "trueNode": "quest_security_offer_text",
      "falseNode": "allow_pass_text"
    },
    "quest_security_offer_text": {
      "type": "TEXT",
      "content": "Actually... there is something. A Crimson Lord has been sighted on Floor 5. It's getting too close to the surface. It needs to be removed.",
      "next": "quest_security_offer_choices"
    },
    "quest_security_offer_choices": {
      "type": "CHOICE",
      "options": [
        { "label": "Consider it done.", "target": "action_offer_security" },
        { "label": "Too dangerous.", "target": "allow_pass_text" }
      ]
    },
    "action_offer_security": {
      "type": "ACTION",
      "action": "OFFER_QUEST",
      "questId": "geraldo_security",
      "acceptNode": "quest_security_active_text",
      "declineNode": "allow_pass_text"
    },
    "quest_security_active_text": {
      "type": "TEXT",
      "content": "Floor 5. Crimson Lord. Don't underestimate it. It drinks blood to heal.",
      "next": "quest_security_active_router"
    },
    "quest_security_active_router": {
      "type": "ROUTER",
      "condition": "flag:security_threat_cleared",
      "trueNode": "quest_security_turnin_text",
      "falseNode": "close_choice"
    },
    "quest_security_turnin_text": {
      "type": "TEXT",
      "content": "You're back. And you're covered in... well, never mind. It's dead? Good.",
      "next": "quest_security_turnin_choices"
    },
    "quest_security_turnin_choices": {
      "type": "CHOICE",
      "options": [
        { "label": "It won't bother you again.", "target": "action_complete_security" }
      ]
    },
    "action_complete_security": {
      "type": "ACTION",
      "action": "COMPLETE_QUEST",
      "questId": "geraldo_security",
      "completeNode": "quest_security_done"
    },
    "quest_security_done": {
       "type": "ROUTER",
       "branches": [
         { "condition": "questStatus:geraldo_badge:inactive", "target": "quest_badge_offer_text" }
       ],
       "next": "quest_security_done_text"
    },
    "quest_security_done_text": {
      "type": "TEXT",
      "content": "You fight like a veteran. Rare to see that these days. Most just run.",
      "next": "allow_pass_choices"
    },
    "quest_badge_offer_text": {
      "type": "TEXT",
      "content": "Since you're heading deep... I lost something. Years ago. Floor 6. My old badge. It's worthless to you, but... it matters to me.",
      "next": "quest_badge_offer_choices"
    },
    "quest_badge_offer_choices": {
      "type": "CHOICE",
      "options": [
        { "label": "I'll find it.", "target": "action_offer_badge" },
        { "label": "I'm busy.", "target": "allow_pass_text" }
      ]
    },
    "action_offer_badge": {
      "type": "ACTION",
      "action": "OFFER_QUEST",
      "questId": "geraldo_badge",
      "acceptNode": "quest_badge_active_text",
      "declineNode": "allow_pass_text"
    },
    "quest_badge_active_text": {
      "type": "TEXT",
      "content": "Floor 6. It's probably rusted by now. Just... bring it back if you see it.",
      "next": "quest_badge_active_router"
    },
    "quest_badge_active_router": {
      "type": "ROUTER",
      "condition": "hasItem:broken_badge",
      "trueNode": "quest_badge_turnin_text",
      "falseNode": "close_choice"
    },
    "quest_badge_turnin_text": {
      "type": "TEXT",
      "content": "You... found it. It's bent. Scratched. ...It's exactly as I left it. Thank you.",
      "next": "quest_badge_turnin_choices"
    },
    "quest_badge_turnin_choices": {
      "type": "CHOICE",
      "options": [
        { "label": "Glad to help.", "target": "action_complete_badge" }
      ]
    },
    "action_complete_badge": {
      "type": "ACTION",
      "action": "COMPLETE_QUEST",
      "questId": "geraldo_badge",
      "completeNode": "quest_badge_done",
      "takeItem": "broken_badge"
    },
    "quest_badge_done": {
      "type": "TEXT",
      "content": "I owe you. Seriously. This badge... it reminds me of when we thought we could win. Here. Take this.",
      "next": "allow_pass_choices"
    }
  }
}

{
  "id": "npc_gate_guard",
  "name": "Gate Guard",
  "layout": "visual_novel",
  "portrait": "NPC_Geraldo",
  "initialNode": "default_router",
  "nodes": {
    "default_router": {
      "type": "ROUTER",
      "branches": [
        { "condition": "questStatus:gatekeeper_key:completed", "target": "gatekeeper_completed_text" },
        { "condition": "questStatus:gatekeeper_key:active", "target": "gatekeeper_active_text" },
        { "condition": "questStatus:lost_scout:completed", "target": "gatekeeper_check" },
        { "condition": "questStatus:lost_scout:active", "target": "scout_active_text" },
        { "condition": "questStatus:silent_shipment:completed", "target": "scout_check" },
        { "condition": "questStatus:silent_shipment:active", "target": "quest_active_router" },
        { "condition": "hasItem:guild_pass", "target": "allow_pass_text" }
      ],
      "next": "deny_pass_text"
    },

    "quest_active_router": {
      "type": "ROUTER",
      "condition": "flag:shipment_investigated",
      "trueNode": "quest_turn_in_text",
      "falseNode": "quest_reminder_text"
    },

    "deny_pass_text": {
      "type": "TEXT",
      "content": "No Guild Pass. Speak to the Guildmaster in town.",
      "next": "deny_pass_choices"
    },
    "deny_pass_choices": {
      "type": "CHOICE",
      "options": [
        { "label": "Anything strange happening?", "target": "quest_offer_text", "condition": "questStatus:silent_shipment:inactive" },
        { "label": "Leave", "action": "close" }
      ]
    },

    "quest_offer_text": {
      "type": "TEXT",
      "content": "Strange? Always. But the supply shipment is late.",
      "next": "quest_offer_choice"
    },
    "quest_offer_choice": {
      "type": "CHOICE",
      "options": [
        { "label": "I'll investigate.", "target": "action_offer_quest" },
        { "label": "Not my problem.", "action": "close" }
      ]
    },
    "action_offer_quest": {
      "type": "ACTION",
      "action": "OFFER_QUEST",
      "questId": "silent_shipment",
      "next": "close_choice"
    },

    "quest_reminder_text": {
      "type": "TEXT",
      "content": "Any news on the shipment? Ask Alicia.",
      "next": "close_choice"
    },

    "quest_turn_in_text": {
      "type": "TEXT",
      "content": "So Alicia heard them stop? Goblins... damn. Thanks.",
      "next": "quest_complete_action"
    },
    "quest_complete_action": {
      "type": "ACTION",
      "action": "COMPLETE_QUEST",
      "questId": "silent_shipment",
      "next": "quest_complete_text"
    },
    "quest_complete_text": {
      "type": "TEXT",
      "content": "You did good work. Watch your back out there.",
      "next": "allow_pass_choices"
    },

    "scout_check": { "type": "ROUTER", "branches": [ { "condition": "level:8", "target": "scout_offer_text" } ], "next": "allow_pass_text" },
    "scout_offer_text": { "type": "TEXT", "content": "I lost a scout in the Frozen Hells (Floor 8). They had a badge. Bring it back, so I can bury it.", "next": "scout_offer_choices" },
    "scout_offer_choices": { "type": "CHOICE", "options": [ { "label": "I'll find them.", "target": "action_offer_scout" }, { "label": "Sorry.", "target": "allow_pass_text" } ] },
    "action_offer_scout": { "type": "ACTION", "action": "OFFER_QUEST", "questId": "lost_scout", "acceptNode": "scout_active_text", "declineNode": "allow_pass_text" },
    "scout_active_text": { "type": "TEXT", "content": "The badge should be on Floor 8.", "next": "scout_turnin_check" },
    "scout_turnin_check": { "type": "ROUTER", "condition": "hasItem:lost_scout_badge", "trueNode": "scout_turnin_text", "falseNode": "allow_pass_text" },
    "scout_turnin_text": { "type": "TEXT", "content": "This is it... scorched by ice. He didn't make it. Thanks.", "next": "scout_turnin_choices" },
    "scout_turnin_choices": { "type": "CHOICE", "options": [ { "label": "Give badge.", "target": "action_complete_scout" } ] },
    "action_complete_scout": { "type": "ACTION", "action": "COMPLETE_QUEST", "questId": "lost_scout", "completeNode": "gatekeeper_check", "takeItem": "lost_scout_badge" },

    "gatekeeper_check": { "type": "ROUTER", "branches": [ { "condition": "level:15", "target": "gatekeeper_offer_text" } ], "next": "allow_pass_text" },
    "gatekeeper_offer_text": { "type": "TEXT", "content": "The Crimson Lord on Floor 6 was bad. But the Spire needs a key to open the top. I think the Crimson Lord was just a shadow. The real one blocks the way deep down.", "next": "gatekeeper_offer_choices" },
    "gatekeeper_offer_choices": { "type": "CHOICE", "options": [ { "label": "I'll kill it.", "target": "action_offer_gatekeeper" } ] },
    "action_offer_gatekeeper": { "type": "ACTION", "action": "OFFER_QUEST", "questId": "gatekeeper_key", "acceptNode": "gatekeeper_active_text", "declineNode": "allow_pass_text" },
    "gatekeeper_active_text": { "type": "TEXT", "content": "Defeat the Crimson Lord again, wherever he hides.", "next": "allow_pass_text" },
    "gatekeeper_completed_text": { "type": "TEXT", "content": "The gate is open? Then God help us.", "next": "allow_pass_text" },

    "allow_pass_text": {
      "type": "TEXT",
      "content": "Guild Pass verified. Go.",
      "next": "allow_pass_choices"
    },
    "allow_pass_choices": {
      "type": "CHOICE",
      "options": [
        { "label": "Enter Dungeon", "target": "action_teleport" },
        { "label": "Leave", "action": "close" }
      ]
    },
    "action_teleport": {
      "type": "ACTION",
      "action": "TELEPORT",
      "target": "dungeon_floor_1"
    },
    "close_choice": {
        "type": "CHOICE",
        "options": [
            { "label": "Leave", "action": "close" }
        ]
    }
  }
}
